{% assign sold_products = customer.metafields.custom.products_sold_by_creator.value %}
{% assign is_creator = false %}
  {% for sold_product in sold_products %}
  {% if sold_product.id == product.id %}
    {% assign is_creator = true %}
  {% endif %}
{% endfor %}

<style>

/* Global */
#wv-product-page {
  padding: 1rem 0rem;
}  
#wv-product-page .title {
  font-family: var(--main-heading-font-family);
  font-size: var(--main-heading-font-size);
  margin-bottom: 5px;
}
#wv-product-page .vendor-link {
  width: fit-content;
  display: flex;
  gap: 7px;
  margin-bottom: 20px;
}
#wv-product-page .vendor-link .label {
  font-size: 20px;
  width: fit-content;
  color: var(--off-black);
  opacity: 0.65;
  margin: 0;
  padding: 0;
  font-size: 16px;
  padding-left: 10px;
}
#wv-product-page .vendor-name {
  font-size: 20px;
  width: fit-content;
  color: var(--off-black);
  margin: 0;
  padding: 0;
}
#wv-product-page .vendor-link:hover .vendor-name {
  text-decoration: underline;
}
@media screen and (max-width: 350px) {
  #atc-btn {
    min-width: 160px !important;
    font-size: 18px !important;
  }
  #wv-product-page .vendor-link .label {
    font-size: 12px;
  }
  #wv-product-page .vendor-name {
    font-size: 15px;
  }
}


/* Creator specific */
{% if is_creator %}
  #wv-product-page .product-img-container img {
    max-height: 400px;
    object-fit: contain;
    max-width: 400px;
    margin: 0 auto;
    box-shadow: 0px 0px 27px -20px black;
    border-radius: 5px;
    height: 100%;
    width: 100%;
  }
  #wv-product-page .product-img-container {
    position: relative;
    width: fit-content;
    margin: 0 auto;
  }
  #wv-product-page .link-list {
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  #wv-product-page .link-list a .link-container {
    display: flex;
    width: fit-content;
    padding: 4px 10px;
    border-radius: 5px;
    border: 1px solid;
    background: var(--pure-white);
  }
  #wv-product-page .link-list a .link-container p {
    margin: 0;
    padding: 0;
  }
  #wv-product-page .link-list a svg {
    height: 20px;
    width: 20px;
  }
  #wv-product-page .price-worn {
    display: flex;
    justify-content: center;
    gap: 10%;
    padding: 1rem;
    font-size: 18px;
  }
  #wv-product-page .price-worn .label {
    text-decoration: underline;
    margin: 0;
    padding: 0;
    font-family: var(--paragraph-font-family);
    font-size: 18px;
    font-weight: normal;
  }
  #wv-product-page .price-worn p {
    margin: 0;
    padding: 0;
    font-family: var(--paragraph-font-family);
    font-size: 18px;
  }
  #wv-product-page .price-worn p span {
    display: block !important;
  }
  #wv-product-page .product-cta {
    display: flex;
    justify-content: center;
    padding: 10px;
    margin: 0 auto;
  }
  #wv-product-page .product-cta button {
    padding: 12px 30px;
    border-radius: 5px;
    background: var(--off-black);
    color: var(--off-white);
    font-weight: bold;
    font-family: var(--main-heading-font-family);
    font-size: 25px;
    border: none;
    cursor: pointer;
    min-width: 200px;
  }
  @media screen and (max-width: 450px) {
    #wv-product-page .product-cta button {
      min-width: 140px;
      font-size: 16px;
    }
  }
  
  /* Edit product styling */
  #wv-product-page {
    padding: 1rem 0;
  }
  #wv-product-page .title {
    font-family: var(--main-heading-font-family);
    font-size: var(--main-heading-font-size);
  }
  #wv-product-page form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 500px;
    margin: 0 auto;
    margin-top: 1rem;
  }
  #wv-product-page label {
    font-weight: bold;
    min-width: 79px;
  }
  #wv-product-page .item-name-container input {
    width: 100%;
  }
  #wv-product-page .description-container {
    display: none;
  }
  #wv-product-page .description-container textarea {
    width: 100%;
    resize: vertical;
    max-height: 300px;
    min-height: 100px;
  }
  #wv-product-page .price-container,
  #wv-product-page .date-container {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  #wv-product-page .price-container {
    margin-top: 3rem;
  }
  #wv-product-page .date-container input {
    cursor: pointer;
  }
  
  /* link list */
  #wv-product-page .worn-links-container {
   padding: 15px 0px; 
  }
  #wv-product-page .worn-links-container .top {
    display: flex;
    gap: 10px;
    align-items: center;
  }
#wv-product-page .worn-links-container .top .text-container {
    display: flex;
    flex-direction: row;
    gap: 5px;
    align-items: center;
}
  #wv-product-page .worn-links-container .top svg {
    height: 35px;
    width: 35px;
    cursor: pointer;
    border: 1px solid;
    padding: 4px;
    border-radius: 5px;
  }
  #wv-product-page .worn-links-container .worn-links-list {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 20px;
  }
  #wv-product-page .worn-links-container .worn-links-list .template {
    display: none !important;
  }
  #wv-product-page .worn-links-container .worn-links-list .link-container {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    margin-top: 15px;
    border: 1px solid;
    padding: 5px 7px;
    border-radius: 5px;
    height: 40px;
  }
  #wv-product-page .worn-links-container .worn-links-list .link-container p {
    margin: 0;
    padding: 0;
  }
  #wv-product-page .worn-links-container .worn-links-list .link-container svg {
    height: 20px;
    width: 20px;
    cursor: pointer;
  }
  #wv-product-page .worn-links-container .worn-links-list .link-container button {
    cursor: pointer;
  }
  #wv-product-page .worn-links-container .worn-links-list .link-container button svg {
    height: 15px;
    width: 15px;
    padding: 3px;
    border-radius: 5px;
  }
    
  /* photos input */
  #wv-product-page .photos-input-container {
    display: flex;
    gap: 10px;
    align-items: center;
    margin: 3rem 0rem;
  }
  #wv-product-page #new-item-photos {
    cursor: pointer;
  }
  #wv-product-page .photo-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }
  #wv-product-page .photo-preview {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 4px;
    overflow: hidden;
  }
  #wv-product-page .photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  #wv-product-page .photo-preview .delete-photo {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--off-white);
  }
  #wv-product-page .submit-btn {
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    padding: 12px 30px;
    border-radius: 5px;
    background: var(--off-black);
    color: var(--off-white);
    font-weight: bold;
    font-family: var(--main-heading-font-family);
    font-size: 25px;
    border: none;
    cursor: pointer;
    min-width: 200px;
  }
  
  /* thank you */
  #wv-product-page .completion-container {
    padding: 1rem;
    display: none;
  }
  #wv-product-page .completion-container button {
    padding: 7px 10px;
    cursor: pointer;
  }
  #wv-product-page .edit-product-container {
    display: none;
    position: relative;
  }
  #wv-product-page .view-preview-container {
    position: absolute;
    right: 0;
    top: -25px;
  }
  #view-preview {
    padding: 5px 7px;
    cursor: pointer;
    border-radius: 5px;
    border: 1px solid var(--off-black);
    background: var(--pure-white);
    font-size: var(--small-font-size);
  }
@media screen and (max-width: 550px) {
    #wv-product-page .photos-input-container {
        flex-direction: column;
        align-items: flex-start;
    }
    #wv-product-page .price-container {
        flex-direction: column;
        align-items: flex-start;  
    }
    #wv-product-page .worn-links-container .top {
        flex-direction: column;
        align-items: flex-start;       
    }
}

  
{% else %} /* Consumer specific */
  #wv-product-page .product-img-container img {
    max-height: 400px;
    object-fit: contain;
    max-width: 400px;
    margin: 0 auto;
    box-shadow: 0px 0px 27px -20px black;
    border-radius: 5px;
    height: 100%;
    width: 100%;
  }
  #wv-product-page .product-img-container {
    position: relative;
    width: fit-content;
    margin: 0 auto;
  }
  #wv-product-page .product-img-container .favourite-star {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 1px solid;
    background: white;
    cursor: pointer;
    padding: 5px;
    transition: 0.3s ease-in-out;
  }
  #wv-product-page .product-img-container .favorited {
    transition: 0.3s ease-in-out;
    background: radial-gradient(circle,rgba(255, 234, 148, 1) 0%, rgba(255, 202, 28, 1) 52%, rgba(255, 202, 28, 1) 100%);
  }
  #wv-product-page .link-list {
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  #wv-product-page .link-list a .link-container {
    display: flex;
    width: fit-content;
    padding: 4px 10px;
    border-radius: 5px;
    border: 1px solid;
    background: var(--pure-white);
  }
  #wv-product-page .link-list a .link-container p {
    margin: 0;
    padding: 0;
  }
  #wv-product-page .link-list a svg {
    height: 20px;
    width: 20px;
  }
  #wv-product-page .price-worn {
    display: flex;
    justify-content: center;
    gap: 10%;
    padding: 1rem;
    font-size: 18px;
  }
  #wv-product-page .price-worn .label {
    text-decoration: underline;
    margin: 0;
    padding: 0;
    font-family: var(--paragraph-font-family);
  }
  #wv-product-page .price-worn p {
    margin: 0;
    padding: 0;
    font-family: var(--paragraph-font-family);
  }
  #wv-product-page .price-worn p span {
    display: block !important;
  }
  #wv-product-page .product-cta {
    display: flex;
    justify-content: center;
    padding: 10px;
    margin: 0 auto;
  }
  #wv-product-page .product-cta button {
    padding: 12px 30px;
    border-radius: 5px;
    background: var(--off-black);
    color: var(--off-white);
    font-weight: bold;
    font-family: var(--main-heading-font-family);
    font-size: 25px;
    border: none;
    cursor: pointer;
    min-width: 200px;
  }
{% endif %}
</style>

<div id='wv-product-page'>
{% if is_creator %}
  <h1 class='title'>{{ product.title }}</h1>

  {% if product.metafields.custom.content_creator_page %}
    <a class='vendor-link' href="{{ product.metafields.custom.content_creator_page.value.url }}">
      <p class='label'>See more of </p>
      <h5 class='vendor-name'>{{ product.vendor }}</h5>
    </a>
  {% endif %}

  <div class='product-preview-container'>
  
    <div class='product-img-container'>
      <img height='160' width='160' src="{{ product.featured_image | image_url: width: 400 }}" alt="{{ product.title }}">
    </div>
  
    {% if product.metafields.custom.links_to_online_content %}
      {% assign content_links = product.metafields.custom.links_to_online_content.value %}
      <div class="link-list">
        {% for link in content_links %}
          {% assign clean_link = link | remove: 'https://' | remove: 'http://' %}
          {% assign root_domain = clean_link | split: '/' | first %}
    
          <a target='_blank' href='{{ link }}'>
            <div class="link-container">
              <svg id="fi_2985013" enable-background="new 0 0 64 64" height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><g><g id="ARC_176_"><g><path d="m36.243 29.758c-.512 0-1.024-.195-1.414-.586-3.119-3.119-8.194-3.12-11.314 0-.78.781-2.048.781-2.828 0-.781-.781-.781-2.047 0-2.828 4.679-4.68 12.292-4.679 16.97 0 .781.781.781 2.047 0 2.828-.39.391-.903.586-1.414.586z"></path></g></g><g id="ARC_175_"><g><path d="m34.829 41.167c-3.073 0-6.146-1.17-8.485-3.509-.781-.781-.781-2.047 0-2.828.78-.781 2.048-.781 2.828 0 3.119 3.119 8.194 3.12 11.314 0 .78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-2.34 2.339-5.413 3.509-8.485 3.509z"></path></g></g><g id="LINE_273_"><g><path d="m41.899 38.243c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l11.172-11.172c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-11.172 11.172c-.39.391-.902.586-1.414.586z"></path></g></g><g id="LINE_272_"><g><path d="m25.071 55.071c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l6.245-6.245c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-6.245 6.245c-.39.391-.902.586-1.414.586z"></path></g></g><g id="LINE_271_"><g><path d="m10.929 40.929c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l11.172-11.171c.781-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-11.172 11.171c-.391.39-.903.586-1.414.586z"></path></g></g><g id="LINE_270_"><g><path d="m32.684 19.175c-.512 0-1.023-.195-1.414-.585-.781-.781-.781-2.047 0-2.829l6.245-6.246c.781-.781 2.047-.781 2.829 0 .781.781.781 2.047 0 2.829l-6.245 6.246c-.391.389-.904.585-1.415.585z"></path></g></g><g id="ARC_174_"><g><path d="m18 57.935c-3.093 0-6.186-1.15-8.485-3.45-4.6-4.6-4.6-12.371 0-16.971.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-3.066 3.066-3.066 8.248 0 11.314s8.248 3.066 11.314 0c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-2.299 2.301-5.392 3.451-8.485 3.451z"></path></g></g><g id="ARC_173_"><g><path d="m53.071 27.071c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828 3.066-3.066 3.066-8.248 0-11.314s-8.248-3.066-11.314 0c-.78.781-2.048.781-2.828 0-.781-.781-.781-2.047 0-2.828 4.6-4.6 12.371-4.6 16.971 0s4.6 12.371 0 16.971c-.391.39-.903.585-1.415.585z"></path></g></g></g></svg>
              <p>{{ root_domain }}</p>
            </div>
          </a>
        {% endfor %}
      </div>
    {% endif %}
  
    <div class='price-worn'>
      <div class='price'>
        <p class='label'>Price:</p>
        <p id='price'>{{ product.price | money }}</p>
      </div>
      {% comment %}
      <div class='worn'>
        <p class='label'>Last worn date:</p>
        <p id='worn-date'>{{ product.metafields.custom.last_worn_date | date: "%B %d, %Y" }}</p>
      </div>
    {% endcomment %}
    </div>
  
    <div class='product-cta'>
      <button id='edit-item-btn'>Edit Item</button>
    </div>
  </div>

  <div class='edit-product-container'>

    <div class='view-preview-container'>
      <button id='view-preview'>View preview</button>
    </div>
  
    <form id="creator-new-item-form">
      <div class='item-name-container input-container'>
        <label for="item-name">Title</label>
        <input placeholder="{{ product.title }}" type="text" id="item-name" name="name" required />
      </div>
  
      <div class='price-container input-container'>
        <label for="item-price">Price (USD)</label>
        <input placeholder="{{ product.price | divided_by: 100 }}" type="number" id="item-price" name="price" step="1" required />
      </div>

      {% comment %}
      <div class='date-container input-container'>
        <label for="item-date">Last Worn</label>
        <input type="date" id="item-date" name="date" value="{{ product.metafields.custom.last_worn_date | date: '%Y-%m-%d' }}" />
      </div>
      {% endcomment %}
  
      <div class='photos-container input-container'>
        <div class='photos-input-container'>
          <label for="new-item-photos">Photos</label>
          <input type="file" id="new-item-photos" name="photos" accept="image/*" multiple />
        </div>
        <div class="photo-preview-container" id="photo-preview"></div>
      </div>
  
      <div class='worn-links-container input-container'>
        <div class='top'>
            <label for="worn-link">Links to Online Content</label>
            <div class='text-container'>
                <input id='worn-link' type='url' name='work-link' />
                <svg id='add-link-btn' version="1.1" id="fi_814208" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 480 480" style="enable-background:new 0 0 480 480;" xml:space="preserve"> <g> <g> <path d="M424,184H296V56c0-30.928-25.072-56-56-56c-30.928,0-56,25.072-56,56v128H56c-30.928,0-56,25.072-56,56 c0,30.928,25.072,56,56,56h128v128c0,30.928,25.072,56,56,56c30.928,0,56-25.072,56-56V296h128c30.928,0,56-25.072,56-56 C480,209.072,454.928,184,424,184z M424,280H288c-4.418,0-8,3.582-8,8v136c0,22.091-17.909,40-40,40c-22.091,0-40-17.909-40-40 V288c0-4.418-3.582-8-8-8H56c-22.091,0-40-17.909-40-40s17.909-40,40-40h136c4.418,0,8-3.582,8-8V56c0-22.091,17.909-40,40-40 c22.091,0,40,17.909,40,40v136c0,4.418,3.582,8,8,8h136c22.091,0,40,17.909,40,40S446.091,280,424,280z"></path> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>
            </div>
        </div>
        <div class='worn-links-list'>
          <div class='link-container template'>
            <svg id="fi_2985013" enable-background="new 0 0 64 64" height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><g><g id="ARC_176_"><g><path d="m36.243 29.758c-.512 0-1.024-.195-1.414-.586-3.119-3.119-8.194-3.12-11.314 0-.78.781-2.048.781-2.828 0-.781-.781-.781-2.047 0-2.828 4.679-4.68 12.292-4.679 16.97 0 .781.781.781 2.047 0 2.828-.39.391-.903.586-1.414.586z"></path></g></g><g id="ARC_175_"><g><path d="m34.829 41.167c-3.073 0-6.146-1.17-8.485-3.509-.781-.781-.781-2.047 0-2.828.78-.781 2.048-.781 2.828 0 3.119 3.119 8.194 3.12 11.314 0 .78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-2.34 2.339-5.413 3.509-8.485 3.509z"></path></g></g><g id="LINE_273_"><g><path d="m41.899 38.243c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l11.172-11.172c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-11.172 11.172c-.39.391-.902.586-1.414.586z"></path></g></g><g id="LINE_272_"><g><path d="m25.071 55.071c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l6.245-6.245c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-6.245 6.245c-.39.391-.902.586-1.414.586z"></path></g></g><g id="LINE_271_"><g><path d="m10.929 40.929c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l11.172-11.171c.781-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-11.172 11.171c-.391.39-.903.586-1.414.586z"></path></g></g><g id="LINE_270_"><g><path d="m32.684 19.175c-.512 0-1.023-.195-1.414-.585-.781-.781-.781-2.047 0-2.829l6.245-6.246c.781-.781 2.047-.781 2.829 0 .781.781.781 2.047 0 2.829l-6.245 6.246c-.391.389-.904.585-1.415.585z"></path></g></g><g id="ARC_174_"><g><path d="m18 57.935c-3.093 0-6.186-1.15-8.485-3.45-4.6-4.6-4.6-12.371 0-16.971.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-3.066 3.066-3.066 8.248 0 11.314s8.248 3.066 11.314 0c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-2.299 2.301-5.392 3.451-8.485 3.451z"></path></g></g><g id="ARC_173_"><g><path d="m53.071 27.071c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828 3.066-3.066 3.066-8.248 0-11.314s-8.248-3.066-11.314 0c-.78.781-2.048.781-2.828 0-.781-.781-.781-2.047 0-2.828 4.6-4.6 12.371-4.6 16.971 0s4.6 12.371 0 16.971c-.391.39-.903.585-1.415.585z"></path></g></g></g></svg>
            <p>onlyfans.com...</p>
            <button><svg id="fi_2961937" height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m4.59 59.41a2 2 0 0 0 2.83 0l24.58-24.58 24.59 24.58a2 2 0 0 0 2.83-2.83l-24.59-24.58 24.58-24.59a2 2 0 0 0 -2.83-2.83l-24.58 24.59-24.59-24.58a2 2 0 0 0 -2.82 2.82l24.58 24.59-24.58 24.59a2 2 0 0 0 0 2.82z"></path></svg></button>
          </div>
        </div>
      </div>
  
      <div class='description-container input-container'>
        <label for="item-description">Description</label>
        <textarea id="item-description" name="description" rows="6">PRODUCT EDIT - URL: https://admin.shopify.com/store/{{ shop.permanent_domain | split: '.myshopify.com' | first }}/products/{{ product.id }}</textarea>
      </div>
  
      <button class='submit-btn' type="submit">Submit Item</button>
      <div class="message" id="submission-message"></div>
    </form>
  
    <div class='completion-container'>
      <h4>Item Edits Received!</h4>
      <p>Our team is carefully re-reviewing your listing to ensure it meets our quality and authenticity standards.</p>
      <p>You’ll hear back from us via email within 24 hours or less.</p>
      <p>We appreciate your patience and your contribution to the vault.</p>
      <a href='/pages/new-item'><button>Submit A New Item</button></a>
    </div>
    
  </div>

  <script>
  // global array of uploaded photos to send to server
  const uploadedPhotos = [];
  
  // select and display new item photos
  document.getElementById('new-item-photos').addEventListener('change', function(e) {
    
    const files = e.target.files;
    const previewContainer = document.getElementById('photo-preview');
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      // only process image files
      if (!file.type.match('image.*')) {
        continue;
      };
      
      const reader = new FileReader();
      
      reader.onload = (function(theFile) {
        return function(e) {
          // Create photo preview
          const photoPreview = document.createElement('div');
          photoPreview.className = 'photo-preview';
          
          const img = document.createElement('img');
          img.src = e.target.result;
          img.title = theFile.name;
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-photo';
          deleteBtn.innerHTML = '×';
          deleteBtn.onclick = function() {
            removePhoto(theFile);
            photoPreview.remove();
          };
          
          photoPreview.appendChild(img);
          photoPreview.appendChild(deleteBtn);
          previewContainer.appendChild(photoPreview);
          
          // store photo data in global array
          uploadedPhotos.push({
            file: theFile,
            preview: e.target.result
          });
        };
      })(file);
      
      reader.readAsDataURL(file);
    }
  });
  
  // delete image from form
  function removePhoto(fileToRemove) {
    const index = uploadedPhotos.findIndex(photo => photo.file === fileToRemove);
    if (index !== -1) {
      uploadedPhotos.splice(index, 1);
    };
  };
  
  // adding links to the link list
  const linkInput = document.querySelector('#creator-new-item-form .worn-links-container .top input');
  const newLinkTemplate = document.querySelector('#creator-new-item-form .worn-links-container .template');  
  const linksListContainer = document.querySelector('#creator-new-item-form .worn-links-list');  
  document.getElementById('add-link-btn').addEventListener('click', (e) => {
    e.preventDefault();
    const link = linkInput.value;
    console.log(link);
    if (!link || link.value ==='') {
      linkInput.style.filter = 'brightness(0.5)';
    } else {
      linkInput.style.filter = 'brightness(1)';
  
      // create new link
      const newLinkContainer = newLinkTemplate.cloneNode(true);
      newLinkContainer.setAttribute('aria-label', `${linkInput.value}`);
      const displayedText = extractRootDomain(linkInput.value);
      newLinkContainer.querySelector('p').textContent = displayedText;
      newLinkContainer.classList.add('user-added-link');
  
      // remove template class & add ability to remove
      newLinkContainer.classList.remove('template');
      newLinkContainer.addEventListener('click', () => {
        newLinkContainer.remove();
      });
    
      // append to list & remove input value
      linksListContainer.appendChild(newLinkContainer);
      linkInput.value = '';
    };
  });
  
  // sending to the server
  document.getElementById('creator-new-item-form').addEventListener('submit', async function(e) {
    e.preventDefault();
  
    const linkElements = document.querySelectorAll('#creator-new-item-form .worn-links-container .user-added-link');
    const ariaLabels = Array.from(linkElements).map(el => el.getAttribute('aria-label'));
  
    // Create FormData
    const formData = new FormData();
    formData.append('email', "{{ customer.email }}");
    formData.append('title', document.getElementById('item-name').value);
    formData.append('description', document.getElementById('item-description').value);
    formData.append('price', document.getElementById('item-price').value);
    // formData.append('date', document.getElementById('item-date').value);
  
    // Attach each photo's real File object
    uploadedPhotos.forEach(photoObj => {
      formData.append('photos', photoObj.file);
    });
  
    // Attach links as individual fields — works best with Express & multer
    if (ariaLabels.length > 0) {
      ariaLabels.forEach(link => formData.append('links', link));
    }
  
    // Debug what is being sent
    for (let [key, value] of formData.entries()) {
      console.log(`${key}:`, value);
    }
  
    // Submit using fetch
    document.querySelector('#creator-new-item-form .submit-btn').textContent = 'Sending...';
  
    try {
      const response = await fetch('https://server.wornvault.com/creator-new-item', {
        method: 'POST',
        body: formData
      });
  
      const status = await response.json();
      console.log('Response from server:', status);
  
      if (status.status === 'success') {
        displayPopup();
      } else {
        document.querySelector('#creator-new-item-form .submit-btn').textContent = 'Something went wrong...';
        document.querySelector('#creator-new-item-form .submit-btn').disabled = true;
      }
    } catch (error) {
      console.log('Failed to send object to server:', error);
    }
  });
  
  // displays the thank you popup
  function displayPopup() {
    document.querySelector('#creator-new-item-form').style.display = 'none';
    document.querySelector('#wv-product-page .completion-container').style.display = 'block';
  };
  
  // Callback functions //
  
  function extractRootDomain(url) {
    try {
      // Add protocol if missing to use URL constructor safely
      if (!url.startsWith('http')) {
        url = 'https://' + url;
      }
  
      const parsed = new URL(url);
      return parsed.hostname + '/';
    } catch (err) {
      console.warn('Invalid URL:', url);
      return '';
    }
  };

  // start editing the product
  document.querySelector('#edit-item-btn').addEventListener('click', () => {
    document.querySelector('#wv-product-page .product-preview-container').style.display = 'none';
    document.querySelector('#wv-product-page .edit-product-container').style.display = 'block';
  });

  // go back to product preview
    document.querySelector('#view-preview').addEventListener('click', () => {
      document.querySelector('#wv-product-page .product-preview-container').style.display = 'block';
      document.querySelector('#wv-product-page .edit-product-container').style.display = 'none';
  });
  
  </script>

    
{% else %}
  
  <h1 class='title'>{{ product.title }}</h1>

  {% if product.metafields.custom.content_creator_page %}
    <a class='vendor-link' href="{{ product.metafields.custom.content_creator_page.value.url }}">
      <p class='label'>See more of </p>
      <h5 class='vendor-name'>{{ product.vendor }}</h5>
    </a>
  {% endif %}
  
  <div class='product-img-container'>
    <svg class='favourite-star' id="fi_2956792" height="512" viewBox="0 0 32 32" width="512" xmlns="http://www.w3.org/2000/svg" data-name="Layer 3"><path d="m23.479 29.691a2.325 2.325 0 0 1 -1.089-.27l-6.233-3.276a.333.333 0 0 0 -.314 0l-6.232 3.276a2.338 2.338 0 0 1 -3.393-2.465l1.19-6.939a.337.337 0 0 0 -.1-.3l-5.038-4.917a2.338 2.338 0 0 1 1.3-3.989l6.963-1.011a.337.337 0 0 0 .254-.185l3.113-6.315a2.337 2.337 0 0 1 4.193 0l3.115 6.313a.34.34 0 0 0 .254.185l6.969 1.012a2.339 2.339 0 0 1 1.3 3.989l-5.043 4.914a.339.339 0 0 0 -.1.3l1.19 6.939a2.341 2.341 0 0 1 -2.3 2.735zm-7.479-5.586a2.325 2.325 0 0 1 1.088.27l6.232 3.275a.321.321 0 0 0 .356-.025.325.325 0 0 0 .135-.331l-1.191-6.94a2.343 2.343 0 0 1 .672-2.069l5.043-4.915a.338.338 0 0 0 -.188-.576l-6.968-1.013a2.335 2.335 0 0 1 -1.76-1.279l-3.119-6.314a.338.338 0 0 0 -.606 0l-3.113 6.312a2.335 2.335 0 0 1 -1.761 1.279l-6.967 1.015a.337.337 0 0 0 -.187.576l5.042 4.915a2.343 2.343 0 0 1 .672 2.069l-1.191 6.94a.338.338 0 0 0 .492.356l6.231-3.276a2.335 2.335 0 0 1 1.088-.269z"></path></svg>
    <img height='160' width='160' src="{{ product.featured_image | image_url: width: 400 }}" alt="{{ product.title }}">
  </div>
  
  {% if product.metafields.custom.links_to_online_content %}
    {% assign content_links = product.metafields.custom.links_to_online_content.value %}
    <div class="link-list">
      {% for link in content_links %}
        {% assign clean_link = link | remove: 'https://' | remove: 'http://' %}
        {% assign root_domain = clean_link | split: '/' | first %}
  
        <a target='_blank' href='{{ link }}'>
          <div class="link-container">
            <svg id="fi_2985013" enable-background="new 0 0 64 64" height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><g><g id="ARC_176_"><g><path d="m36.243 29.758c-.512 0-1.024-.195-1.414-.586-3.119-3.119-8.194-3.12-11.314 0-.78.781-2.048.781-2.828 0-.781-.781-.781-2.047 0-2.828 4.679-4.68 12.292-4.679 16.97 0 .781.781.781 2.047 0 2.828-.39.391-.903.586-1.414.586z"></path></g></g><g id="ARC_175_"><g><path d="m34.829 41.167c-3.073 0-6.146-1.17-8.485-3.509-.781-.781-.781-2.047 0-2.828.78-.781 2.048-.781 2.828 0 3.119 3.119 8.194 3.12 11.314 0 .78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-2.34 2.339-5.413 3.509-8.485 3.509z"></path></g></g><g id="LINE_273_"><g><path d="m41.899 38.243c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l11.172-11.172c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-11.172 11.172c-.39.391-.902.586-1.414.586z"></path></g></g><g id="LINE_272_"><g><path d="m25.071 55.071c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l6.245-6.245c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-6.245 6.245c-.39.391-.902.586-1.414.586z"></path></g></g><g id="LINE_271_"><g><path d="m10.929 40.929c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828l11.172-11.171c.781-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828l-11.172 11.171c-.391.39-.903.586-1.414.586z"></path></g></g><g id="LINE_270_"><g><path d="m32.684 19.175c-.512 0-1.023-.195-1.414-.585-.781-.781-.781-2.047 0-2.829l6.245-6.246c.781-.781 2.047-.781 2.829 0 .781.781.781 2.047 0 2.829l-6.245 6.246c-.391.389-.904.585-1.415.585z"></path></g></g><g id="ARC_174_"><g><path d="m18 57.935c-3.093 0-6.186-1.15-8.485-3.45-4.6-4.6-4.6-12.371 0-16.971.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-3.066 3.066-3.066 8.248 0 11.314s8.248 3.066 11.314 0c.78-.781 2.048-.781 2.828 0 .781.781.781 2.047 0 2.828-2.299 2.301-5.392 3.451-8.485 3.451z"></path></g></g><g id="ARC_173_"><g><path d="m53.071 27.071c-.512 0-1.024-.195-1.414-.586-.781-.781-.781-2.047 0-2.828 3.066-3.066 3.066-8.248 0-11.314s-8.248-3.066-11.314 0c-.78.781-2.048.781-2.828 0-.781-.781-.781-2.047 0-2.828 4.6-4.6 12.371-4.6 16.971 0s4.6 12.371 0 16.971c-.391.39-.903.585-1.415.585z"></path></g></g></g></svg>
            <p>{{ root_domain }}</p>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

  <div class='price-worn'>
    <div class='price'>
      <p class='label'>Price:</p>
      <p id='price'>{{ product.price | money }}</p>
    </div>
    {% comment %}
    <div class='worn'>
      <p class='label'>Last worn date:</p>
      <p id='worn-date'>{{ product.metafields.custom.last_worn_date | date: "%B %d, %Y" }}</p>
    </div>
    {% endcomment %}
  </div>
  <div class='product-cta'>
    <button id='atc-btn'>Add To Cart</button>
  </div>

  <script>
    document.getElementById('atc-btn').addEventListener('click', async () => {
      const btn = document.getElementById('atc-btn');
    
      let dotCount = 0;
      const baseText = 'Adding';
      
      // Start dot animation
      const dotInterval = setInterval(() => {
        dotCount = (dotCount + 1) % 4; // 0 to 3 dots
        btn.textContent = baseText + '.'.repeat(dotCount);
      }, 400); // Adjust speed of dot animation here
    
      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            id: "{{ product.selected_or_first_available_variant.id }}",
            quantity: 1
          })
        });
    
        if (!response.ok) throw new Error('Add to cart failed');
    
        const cartItem = await response.json();
        console.log('Item added:', cartItem);
    
        // Delay before resetting button and updating UI
        setTimeout(() => {
          clearInterval(dotInterval); // Stop dot animation
          btn.textContent = 'Add To Cart';
          updateCartCount();
          addedItemToCart(cartItem);
        }, 1000);
    
      } catch (err) {
        clearInterval(dotInterval); // Stop animation on error too
        btn.textContent = 'Add To Cart';
        console.error('Cart error:', err);
        alert('Could not add item to cart.');
      }
    });

  </script>
  
{% endif %}
</div>

{% schema %}
  {
    "name": "WV Product Page",
    "settings": [],
    "presets": [
      {
        "name": "WV Product Page",
      }
    ]
  }
{% endschema %}