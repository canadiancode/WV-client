{%- comment -%}
  Google Analytics snippet
  Usage: {% render 'google-analytics', ga_id: 'GA_MEASUREMENT_ID' %}
{%- endcomment -%}

{%- if ga_id -%}
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga_id }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{{ ga_id }}', {
      'anonymize_ip': true,
      'cookie_flags': 'SameSite=None;Secure'
    });
    
    // Enhanced ecommerce tracking
    gtag('config', '{{ ga_id }}', {
      'send_page_view': false
    });
  </script>

  <!-- Google Analytics Enhanced Ecommerce -->
  <script>
    // Track page views
    gtag('event', 'page_view', {
      'page_title': '{{ page_title | escape }}',
      'page_location': '{{ canonical_url }}',
      'page_path': '{{ request.path }}'
    });

    // Track product views
    {%- if template contains 'product' -%}
    gtag('event', 'view_item', {
      'currency': '{{ cart.currency.iso_code }}',
      'value': {{ product.price | money_without_currency | remove: ',' }},
      'items': [{
        'item_id': '{{ product.id }}',
        'item_name': '{{ product.title | escape }}',
        'item_category': '{{ product.type | escape }}',
        'item_brand': '{{ product.vendor | escape }}',
        'price': {{ product.price | money_without_currency | remove: ',' }},
        'quantity': 1
      }]
    });
    {%- endif -%}

    // Track collection views
    {%- if template contains 'collection' -%}
    gtag('event', 'view_item_list', {
      'item_list_name': '{{ collection.title | escape }}',
      'items': [
        {%- for product in collection.products limit: 10 -%}
        {
          'item_id': '{{ product.id }}',
          'item_name': '{{ product.title | escape }}',
          'item_category': '{{ product.type | escape }}',
          'item_brand': '{{ product.vendor | escape }}',
          'price': {{ product.price | money_without_currency | remove: ',' }},
          'index': {{ forloop.index0 }}
        }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]
    });
    {%- endif -%}

    // Track search
    {%- if template contains 'search' -%}
    gtag('event', 'search', {
      'search_term': '{{ search.terms | escape }}',
      'search_results': {{ search.results_count }}
    });
    {%- endif -%}
  </script>
{%- endif -%}
